<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LinkSnip - Professional URL Shortener</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #f5f7fa;
      min-height: 100vh;
      padding: 30px 20px;
    }

    body::before {
      display: none;
    }

    .container {
      display: grid;
      grid-template-columns: 1fr 1.2fr;
      gap: 20px;
      max-width: 1400px;
      margin: 0 auto;
      min-height: calc(100vh - 40px);
    }

    @media (max-width: 968px) {
      .container {
        grid-template-columns: 1fr;
      }
    }

    .left-panel {
      background: white;
      border-radius: 12px;
      padding: 40px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      border: 1px solid #e5e7eb;
      display: flex;
      flex-direction: column;
    }

    .right-panel {
      background: white;
      border-radius: 12px;
      padding: 40px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      border: 1px solid #e5e7eb;
      overflow-y: auto;
    }

    .logo {
      text-align: center;
      margin-bottom: 20px;
    }

    .logo svg {
      width: 40px;
      height: 40px;
      margin-bottom: 8px;
    }

    h1 {
      color: #111827;
      text-align: center;
      margin-bottom: 8px;
      font-size: 2em;
      font-weight: 600;
      letter-spacing: -0.01em;
    }

    .subtitle {
      text-align: center;
      color: #6b7280;
      font-size: 0.95em;
      margin-bottom: 32px;
      font-weight: 400;
    }

    .input-group {
      margin-bottom: 25px;
      position: relative;
    }

    label {
      display: block;
      margin-bottom: 8px;
      color: #374151;
      font-weight: 500;
      font-size: 0.9em;
    }

    .input-wrapper {
      position: relative;
    }

    input[type="text"] {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 15px;
      transition: all 0.2s ease;
      background: white;
      font-family: inherit;
      color: #111827;
    }

    input[type="text"]:focus {
      outline: none;
      border-color: #1e40af;
      box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
    }

    input[type="text"]::placeholder {
      color: #9ca3af;
    }

    .btn-primary {
      width: 100%;
      padding: 12px;
      background: #1e40af;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-top: 10px;
      font-family: inherit;
    }

    .btn-primary:hover {
      background: #1e3a8a;
    }

    .btn-primary:active {
      background: #172554;
    }

    .btn-secondary {
      width: 100%;
      padding: 14px;
      background: white;
      color: #1e40af;
      border: 2px solid #1e40af;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 12px;
    }

    .btn-secondary:hover {
      background: #dbeafe;
      transform: translateY(-1px);
    }

    .result {
      margin-top: 24px;
      padding: 20px;
      background: #f9fafb;
      border-radius: 8px;
      display: none;
      border: 1px solid #e5e7eb;
    }

    .result.show {
      display: block;
    }

    .result h3 {
      color: #111827;
      margin-bottom: 12px;
      font-size: 0.9em;
      font-weight: 500;
    }

    .url-box {
      display: flex;
      gap: 12px;
      margin-bottom: 12px;
      align-items: stretch;
    }

    .url-display {
      flex: 1;
      padding: 10px 14px;
      background: white;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      color: #1e40af;
      font-weight: 500;
      word-break: break-all;
      font-size: 14px;
      display: flex;
      align-items: center;
    }

    .copy-btn {
      padding: 10px 20px;
      background: #1e40af;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      font-size: 14px;
      width: auto;
      margin: 0;
      transition: all 0.2s ease;
      white-space: nowrap;
    }

    .copy-btn:hover {
      background: #1e3a8a;
    }

    .analytics {
      display: block;
    }

    .analytics h3 {
      color: #111827;
      margin-bottom: 16px;
      font-size: 1.1em;
      font-weight: 600;
    }

    .stat-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 18px;
      margin: 24px 0;
    }

    .stat-card {
      background: #f9fafb;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
      border: 1px solid #e5e7eb;
      transition: all 0.2s ease;
    }

    .stat-card:hover {
      border-color: #1e40af;
      background: #dbeafe;
    }

    .stat-value {
      font-size: 2em;
      font-weight: 600;
      color: #111827;
    }

    .stat-label {
      color: #6b7280;
      margin-top: 6px;
      font-weight: 400;
      font-size: 0.85em;
    }

    .section-title {
      color: #111827;
      margin: 24px 0 12px;
      font-size: 1em;
      font-weight: 500;
    }

    .click-list {
      max-height: 340px;
      overflow-y: auto;
      margin-top: 18px;
    }

    .click-list::-webkit-scrollbar {
      width: 6px;
    }

    .click-list::-webkit-scrollbar-track {
      background: #f9fafb;
      border-radius: 3px;
    }

    .click-list::-webkit-scrollbar-thumb {
      background: #d1d5db;
      border-radius: 3px;
    }

    .click-list::-webkit-scrollbar-thumb:hover {
      background: #9ca3af;
    }

    .click-item {
      background: white;
      padding: 14px 16px;
      border-radius: 8px;
      margin-bottom: 10px;
      font-size: 13px;
      border: 1px solid #e5e7eb;
      transition: all 0.2s ease;
    }

    .click-item:hover {
      border-color: #d1d5db;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .click-item strong {
      color: #111827;
      display: block;
      margin-bottom: 6px;
      font-weight: 500;
      font-size: 13px;
    }

    .click-item div {
      color: #6b7280;
      line-height: 1.6;
    }

    .error {
      background: #fef2f2;
      color: #991b1b;
      padding: 12px 16px;
      border-radius: 8px;
      margin-top: 16px;
      display: none;
      border: 1px solid #fecaca;
      font-weight: 400;
      font-size: 14px;
    }

    .error.show {
      display: block;
    }

    .footer {
      text-align: center;
      margin-top: auto;
      padding-top: 20px;
      border-top: 1px solid #e5e7eb;
      color: #9ca3af;
      font-size: 0.85em;
    }

    .header-auth {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .auth-buttons {
      display: flex;
      gap: 10px;
    }

    .btn-link {
      padding: 8px 16px;
      background: white;
      color: #1e40af;
      border: 1px solid #1e40af;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      text-decoration: none;
      display: inline-block;
    }

    .btn-link:hover {
      background: #dbeafe;
    }

    .user-info {
      font-size: 13px;
      color: #6b7280;
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .qr-code {
      text-align: center;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid #e5e7eb;
    }

    .qr-code img {
      max-width: 150px;
      margin: 10px auto;
    }

    .qr-code h4 {
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 10px;
    }

    @media (max-width: 968px) {
      .container {
        grid-template-columns: 1fr;
      }
      
      .left-panel, .right-panel {
        padding: 30px;
      }

      h1 {
        font-size: 1.75em;
      }

      .stat-grid {
        grid-template-columns: 1fr;
      }

      .url-box {
        flex-direction: column;
      }

      .copy-btn {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- LEFT PANEL: URL Shortener -->
    <div class="left-panel">
      <!-- Header with Auth -->
      <div class="header-auth">
        <div></div> <!-- Spacer -->
        <div id="authSection">
          <div class="auth-buttons" id="guestButtons">
            <a href="/login.html" class="btn-link">Login</a>
            <a href="/signup.html" class="btn-link">Sign Up</a>
          </div>
          <div class="user-info" id="userInfo" style="display: none;">
            <span id="userName"></span>
            <a href="/dashboard.html" class="btn-link">Dashboard</a>
            <button class="btn-link" onclick="logout()">Logout</button>
          </div>
        </div>
      </div>

      <div class="logo">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M10 13C10.4295 13.5741 10.9774 14.0491 11.6066 14.3929C12.2357 14.7367 12.9315 14.9411 13.6467 14.9923C14.3618 15.0435 15.0796 14.9403 15.7513 14.6897C16.4231 14.4392 17.0331 14.047 17.54 13.54L20.54 10.54C21.4508 9.59695 21.9548 8.33394 21.9434 7.02296C21.932 5.71198 21.4061 4.45791 20.4791 3.53087C19.5521 2.60383 18.298 2.07799 16.987 2.0666C15.676 2.05521 14.413 2.55918 13.47 3.47L11.75 5.18" stroke="#1e40af" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M14 11C13.5705 10.4259 13.0226 9.9509 12.3934 9.60711C11.7642 9.26331 11.0685 9.05889 10.3533 9.00768C9.63816 8.95646 8.92037 9.05965 8.24861 9.31023C7.57685 9.5608 6.96684 9.95303 6.45996 10.46L3.45996 13.46C2.54917 14.403 2.04519 15.6661 2.05659 16.977C2.06798 18.288 2.59382 19.5421 3.52086 20.4691C4.4479 21.3962 5.70197 21.922 7.01295 21.9334C8.32393 21.9448 9.58694 21.4408 10.53 20.53L12.24 18.82" stroke="#1e40af" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>
      
      <h1>URL Shortener</h1>
      <p class="subtitle">Create short links and track analytics</p>
      
      <div class="input-group">
        <label for="originalUrl">Enter URL to shorten</label>
        <div class="input-wrapper">
          <input type="text" id="originalUrl" placeholder="https://example.com/your-very-long-url-here">
        </div>
      </div>

      <div class="input-group" id="customAliasGroup" style="display: none;">
        <label for="customAlias">Custom Alias (Optional)</label>
        <div class="input-wrapper">
          <input type="text" id="customAlias" placeholder="my-custom-link" pattern="[a-zA-Z0-9-_]+" minlength="3" maxlength="20">
        </div>
        <p style="margin-top: 4px; font-size: 12px; color: #9ca3af;">3-20 characters. Letters, numbers, hyphens, and underscores only.</p>
      </div>
      
      <button class="btn-primary" onclick="shortenUrl()">Shorten URL</button>
      
      <div class="error" id="error"></div>
      
      <div class="result" id="result">
        <h3>Your shortened link:</h3>
        <div class="url-box">
          <div class="url-display" id="shortUrl"></div>
          <button class="copy-btn" onclick="copyUrl(event)">Copy</button>
        </div>
        <div class="qr-code" id="qrCode" style="display: none;">
          <h4>Scan QR Code</h4>
          <img id="qrImage" src="" alt="QR Code">
        </div>
        <p style="margin-top: 10px; font-size: 12px; color: #9ca3af;">Click the link to test redirection, then view analytics on the right</p>
      </div>

      <div class="footer">
        Â© 2026 URL Shortener
      </div>
    </div>

    <!-- RIGHT PANEL: Analytics -->
    <div class="right-panel">
      <div class="analytics" id="analytics">
        <h3>Analytics Dashboard</h3>
        <p style="color: #9ca3af; margin-bottom: 20px; font-size: 14px;">Create a short URL to view click statistics and user data</p>
        <div class="stat-grid">
          <div class="stat-card">
            <div class="stat-value" id="totalClicks">0</div>
            <div class="stat-label">Total Clicks</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="createdDate">-</div>
            <div class="stat-label">Created On</div>
          </div>
        </div>
        <h4 class="section-title">Recent Clicks</h4>
        <div class="click-list" id="clickList">
          <p style="color: #a0aec0; text-align: center; padding: 20px;">No clicks yet. Create and click a short URL to see analytics here.</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    let currentShortCode = '';
    let currentQRCode = '';

    // Check authentication status
    function checkAuth() {
      const token = localStorage.getItem('token');
      const user = JSON.parse(localStorage.getItem('user') || '{}');
      
      if (token && user.name) {
        document.getElementById('guestButtons').style.display = 'none';
        document.getElementById('userInfo').style.display = 'flex';
        document.getElementById('userName').textContent = user.name;
        document.getElementById('customAliasGroup').style.display = 'block';
      } else {
        document.getElementById('guestButtons').style.display = 'flex';
        document.getElementById('userInfo').style.display = 'none';
        document.getElementById('customAliasGroup').style.display = 'none';
      }
    }

    function logout() {
      localStorage.removeItem('token');
      localStorage.removeItem('user');
      window.location.reload();
    }

    async function shortenUrl() {
      const originalUrl = document.getElementById('originalUrl').value;
      const customAlias = document.getElementById('customAlias').value;
      const errorDiv = document.getElementById('error');
      const resultDiv = document.getElementById('result');
      const qrCodeDiv = document.getElementById('qrCode');
      const token = localStorage.getItem('token');
      
      if (!originalUrl) {
        showError('Please enter a URL');
        return;
      }

      const headers = {
        'Content-Type': 'application/json'
      };

      if (token) {
        headers['Authorization'] = `Bearer ${token}`;
      }

      try {
        const body = { originalUrl };
        if (customAlias) {
          body.customAlias = customAlias;
        }

        const response = await fetch('/api/shorten', {
          method: 'POST',
          headers: headers,
          body: JSON.stringify(body)
        });

        const data = await response.json();

        if (response.ok) {
          document.getElementById('shortUrl').textContent = data.shortUrl;
          currentShortCode = data.shortCode || data.customAlias;
          currentQRCode = data.qrCode;
          
          // Show QR code if available
          if (data.qrCode) {
            document.getElementById('qrImage').src = data.qrCode;
            qrCodeDiv.style.display = 'block';
          } else {
            qrCodeDiv.style.display = 'none';
          }
          
          resultDiv.classList.add('show');
          errorDiv.classList.remove('show');
          
          // Clear custom alias field
          if (customAlias) {
            document.getElementById('customAlias').value = '';
          }
          
          // Auto-load analytics
          viewAnalytics();
        } else {
          showError(data.error || 'Something went wrong');
        }
      } catch (error) {
        showError('Failed to shorten URL. Make sure the server is running.');
      }
    }

    function copyUrl(event) {
      const shortUrl = document.getElementById('shortUrl').textContent;
      navigator.clipboard.writeText(shortUrl).then(() => {
        const btn = event.target;
        const originalText = btn.textContent;
        btn.textContent = 'Copied!';
        btn.style.background = '#10b981';
        setTimeout(() => {
          btn.textContent = originalText;
          btn.style.background = '#1e40af';
        }, 2000);
      }).catch(() => {
        showError('Failed to copy. Please copy manually.');
      });
    }

    async function viewAnalytics() {
      if (!currentShortCode) return;

      try {
        const response = await fetch(`/api/analytics/${currentShortCode}`);
        const data = await response.json();

        if (response.ok) {
          document.getElementById('totalClicks').textContent = data.clicks;
          
          const createdDate = new Date(data.createdAt);
          const formattedCreated = createdDate.toLocaleDateString('en-US', { 
            month: 'short', 
            day: 'numeric' 
          });
          document.getElementById('createdDate').textContent = formattedCreated;

          const clickList = document.getElementById('clickList');
          clickList.innerHTML = '';

          if (data.clickDetails.length > 0) {
            data.clickDetails.reverse().slice(0, 10).forEach(click => {
              const clickItem = document.createElement('div');
              clickItem.className = 'click-item';
              const date = new Date(click.timestamp);
              const formattedDate = date.toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric', 
                year: 'numeric' 
              });
              const formattedTime = date.toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit' 
              });
              
              clickItem.innerHTML = `
                <strong>${formattedDate} at ${formattedTime}</strong>
                <div style="margin-top: 8px; line-height: 1.8;">
                  <div>
                    <span style="display: inline-block; min-width: 80px; color: #718096; font-weight: 600;">IP:</span>
                    <span>${click.ip}</span>
                  </div>
                  ${click.location && click.location.country !== 'Unknown' ? `
                  <div>
                    <span style="display: inline-block; min-width: 80px; color: #718096; font-weight: 600;">Location:</span>
                    <span>${click.location.city || ''}, ${click.location.region || ''}, ${click.location.country || 'Unknown'}</span>
                  </div>
                  ` : (click.ip === '::1' || click.ip === '127.0.0.1' || click.ip.startsWith('192.168') || click.ip.startsWith('10.')) ? `
                  <div>
                    <span style="display: inline-block; min-width: 80px; color: #718096; font-weight: 600;">Location:</span>
                    <span style="color: #a0aec0;">Local Network (not trackable)</span>
                  </div>
                  ` : ''}
                  ${click.device ? `
                  <div>
                    <span style="display: inline-block; min-width: 80px; color: #718096; font-weight: 600;">Device:</span>
                    <span>${click.device.type ? click.device.type.charAt(0).toUpperCase() + click.device.type.slice(1) : 'Desktop'}</span>
                  </div>
                  ` : ''}
                  ${click.browser ? `
                  <div>
                    <span style="display: inline-block; min-width: 80px; color: #718096; font-weight: 600;">Browser:</span>
                    <span>${click.browser.name} ${click.browser.version || ''}</span>
                  </div>
                  ` : ''}
                  ${click.os ? `
                  <div>
                    <span style="display: inline-block; min-width: 80px; color: #718096; font-weight: 600;">OS:</span>
                    <span>${click.os.name} ${click.os.version || ''}</span>
                  </div>
                  ` : ''}
                  <div>
                    <span style="display: inline-block; min-width: 80px; color: #718096; font-weight: 600;">Referer:</span>
                    <span>${click.referer}</span>
                  </div>
                </div>
              `;
              clickList.appendChild(clickItem);
            });
          } else {
            clickList.innerHTML = '<div class="click-item" style="text-align: center; color: #a0aec0;">No clicks yet. Share your link to see analytics!</div>';
          }

          document.getElementById('analytics').classList.add('show');
        }
      } catch (error) {
        showError('Failed to load analytics');
      }
    }

    function showError(message) {
      const errorDiv = document.getElementById('error');
      errorDiv.textContent = message;
      errorDiv.classList.add('show');
      setTimeout(() => {
        errorDiv.classList.remove('show');
      }, 3000);
    }

    // Allow pressing Enter to shorten URL
    document.getElementById('originalUrl').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        shortenUrl();
      }
    });

    // Check auth on page load
    checkAuth();
  </script>
</body>
</html>
